stages:
  - install
  - build
  - Security
  - dockerbuild

install:
  stage: install
  script:
    - sudo apt-get install wget apt-transport-https gnupg lsb-release
    - wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    - echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
    - sudo apt-get update
    - sudo apt-get install trivy
  tags:
    - slave1  

build:
  stage: build
  image: node:18.9.1
  script:
    - cd mern/backend
    - npm install
  artifacts:
    paths:
      - mern/backend/node_modules
  tags:
    - slave2

trivy-fs-backend-scan:
  stage: Security
  # image: aquasec/trivy:latest
  script:
    - cd mern/backend
    - trivy fs --format table -o trivyfs.html .
  artifacts:
    paths:
      - mern/backend/trivyfs.html
  tags:
    - slave1


build-backend-Docker:
  stage: dockerbuild
  script:
#    - sudo apt install docker.io -y && sudo usermod -aG docker ubuntu
    - docker login -u $username -p $password 
    - cd mern/backend
    - docker buld -t prasannakumarsinganamalla431/backendMARN:v1 -f dockerfile-ci .
    - docker push prasannakumarsinganamalla431/backendMARN:v1
  dependencies:
    - build  
  tags:
    - slave1   