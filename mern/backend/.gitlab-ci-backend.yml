stages:
  - build
  - Security
  - dockerbuild
  - dockerimagescan
  - dockerpush 

services: 
  - docker:dind

backend-build:
  stage: build
  image: node:18.9.1
  script:
    - cd mern/backend
    - npm install
  artifacts:
    paths:
      - mern/backend/node_modules
  tags:
    - slave2

trivy-fs-backend-scan:
  stage: Security
  script:
    - cd mern/backend
    - trivy fs --format table -o trivyfs.html .
  artifacts:
    paths:
      - mern/backend/trivyfs.html
  tags:
    - slave1

sonarqube-check:
  stage: Security
  image: 
    name: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script: 
    - sonar-scanner
  allow_failure: true
  tags:
    - slave2




build-backend-Docker:
  stage: dockerbuild
  script:
#    - sudo apt install docker.io -y && sudo usermod -aG docker ubuntu
    - docker login -u $username -p $password 
    - cd mern/backend
    - ls 
    - docker build -t prasannakumarsinganamalla431/backendmarn:$CI_PIPELINE_ID -f dockerfile-ci .
    - docker save -o backendmarn_$CI_PIPELINE_ID.tar prasannakumarsinganamalla431/backendmarn:$CI_PIPELINE_ID
    # - docker push prasannakumarsinganamalla431/backendmarn:$CI_PIPELINE_ID
  dependencies:
    - backend-build  
  artifacts:
    path:
      - mern/backend
  tags:
    - slave1



trivy-backend-imagescan:
  stage: dockerimagescan
  script:
    #- trivy image --exit-code 1 --severity HIGH,CRITICAL $IMAGE_TAG
    - docker load -i frontendmarn_$CI_PIPELINE_ID.tar
    - trivy image --scanners vuln --format table --output trivy-image-scan.txt prasannakumarsinganamalla431/backendmarn:$CI_PIPELINE_ID
  
  dependencies:
    - build-backend-Docker
  tags:
    - slave1  

docker-backend-push:
  stage: dockerpush
  script:
    - docker login -u $username -p $password
    - cd mern/backend
    - ls 
    - docker load -i frontendmarn_$CI_PIPELINE_ID.tar
    - docker push prasannakumarsinganamalla431/frontendmarn:$CI_PIPELINE_ID
  dependencies:
    - build-backend-Docker
  tags:
    - slave1